<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendei Pro - Espaço Klebylenne Moraes</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #7b5ea7;
            --secondary: #fdf4ff;
            --accent: #ff6b81;
            --bg: linear-gradient(135deg, #f8e8ee, #e3f2fd);
        }

        body {
            margin: 0; font-family: 'Poppins', sans-serif;
            background: var(--bg); min-height: 100vh;
            display: flex; flex-direction: column; align-items: center; padding: 20px;
        }

        .container {
            background: white; width: 100%; max-width: 500px;
            border-radius: 20px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* Menu de Abas */
        .nav-tabs {
            display: flex; justify-content: space-around;
            margin-bottom: 25px; border-bottom: 2px solid #eee;
        }
        .tab-item {
            padding: 10px; cursor: pointer; font-weight: 600;
            color: #999; transition: 0.3s;
        }
        .tab-item.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        /* Seções */
        .content-section { display: none; }
        .content-section.active { display: block; }

        h1, h2 { text-align: center; color: var(--primary); margin-top: 0; }
        
        label { font-size: 14px; font-weight: 500; color: #555; display: block; margin-top: 10px; }
        input, select, button {
            width: 100%; padding: 12px; margin-top: 6px;
            border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box;
        }

        button {
            background-color: var(--primary); color: white; border: none;
            font-weight: 600; cursor: pointer; margin-top: 20px;
        }
        button:hover { background-color: #684a91; }

        /* Dashboard Cards */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--secondary); padding: 15px; border-radius: 12px; text-align: center; }
        .stat-card span { display: block; font-size: 20px; font-weight: 600; color: var(--primary); }

        /* Lista de Agendamentos */
        .card {
            background: var(--secondary); padding: 12px; border-radius: 12px;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .btn-excluir { width: auto; background: var(--accent); font-size: 11px; padding: 6px 10px; margin: 0; }

        .footer { text-align: center; font-size: 12px; margin-top: 20px; color: #999; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-tabs">
        <div class="tab-item active" onclick="switchTab('agendar')">Agendar</div>
        <div class="tab-item" onclick="switchTab('dashboard')">Dashboard</div>
        <div class="tab-item" onclick="switchTab('config')">Ajustes</div>
    </div>

    <div id="agendar" class="content-section active">
        <h1>Novo Agendamento</h1>
        <label>Nome da Cliente</label>
        <input type="text" id="nome">
        
        <label>Telefone</label>
        <input type="text" id="telefone" placeholder="DDD + Número">

        <label>Data</label>
        <input type="date" id="data_input">

        <label>Horário</label>
        <input type="time" id="hora_input">

        <button id="btnSalvar">Confirmar e Enviar WhatsApp</button>
        
        <div style="margin-top: 25px;">
            <h3 id="titulo_lista">Agendamentos do Dia</h3>
            <div id="lista_agendamentos"></div>
        </div>
    </div>

    <div id="dashboard" class="content-section">
        <h2>Seu Desempenho</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <small>Hoje</small>
                <span id="count_hoje">0</span>
            </div>
            <div class="stat-card">
                <small>No Mês</small>
                <span id="count_mes">0</span>
            </div>
        </div>
        <p style="font-size: 13px; color: #666; text-align: center;">Métricas automáticas baseadas na nuvem.</p>
    </div>

    <div id="config" class="content-section">
        <h2>Configurações</h2>
        <label>Nome do Estabelecimento</label>
        <input type="text" value="Espaço Klebylenne Moraes">
        
        <label>Mensagem Padrão WhatsApp</label>
        <textarea id="msg_padrao" style="width:100%; border-radius:10px; padding:10px; border:1px solid #ddd;">Olá [NOME], seu horário está confirmado para [DATA] às [HORA].</textarea>
        
        <button onclick="alert('Configurações salvas (Localmente)')">Salvar Preferências</button>
    </div>

    <div class="footer">Sistema Pro • Versão 0.4</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAxyovmqjNYIzOYYDZZnduquiJQeK4UIgc",
        authDomain: "agendei-d721e.firebaseapp.com",
        projectId: "agendei-d721e",
        storageBucket: "agendei-d721e.firebasestorage.app",
        messagingSenderId: "525023801595",
        appId: "1:525023801595:web:71a6d72e986e6e9e30005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const agendamentosRef = collection(db, "agendamentos");

    // LÓGICA DE NAVEGAÇÃO
    window.switchTab = (tabId) => {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    };

    // SALVAR COM VALIDAÇÃO DE CONFLITO
    document.getElementById('btnSalvar').onclick = async () => {
        const nome = document.getElementById('nome').value;
        const telefone = document.getElementById('telefone').value;
        const data = document.getElementById('data_input').value;
        const hora = document.getElementById('hora_input').value;

        if(!nome || !data || !hora) return alert("Preencha o básico!");

        // VERIFICA CONFLITO NO FIREBASE
        const qConflito = query(agendamentosRef, where("data", "==", data), where("hora", "==", hora));
        const check = await getDocs(qConflito);
        
        if(!check.empty) {
            alert("⚠️ Esse horário já está ocupado!");
            return;
        }

        try {
            await addDoc(agendamentosRef, { nome, telefone, data, hora, timestamp: new Date() });
            
            // WHATSAPP
            const msg = `Olá ${nome}, seu horário no Espaço Klebylenne Moraes está confirmado: ${data} às ${hora}.`;
            window.open(`https://wa.me/55${telefone}?text=${encodeURIComponent(msg)}`, "_blank");
            
            document.getElementById('nome').value = "";
        } catch (e) { console.error(e); }
    };

    // LISTAGEM E DASHBOARD EM TEMPO REAL
    document.getElementById('data_input').onchange = (e) => {
        const dataSel = e.target.value;
        const q = query(agendamentosRef, where("data", "==", dataSel), orderBy("hora", "asc"));

        onSnapshot(q, (snapshot) => {
            const lista = document.getElementById('lista_agendamentos');
            lista.innerHTML = "";
            document.getElementById('count_hoje').innerText = snapshot.size; // Atualiza Dashboard

            snapshot.forEach(docSnap => {
                const ag = docSnap.data();
                const item = document.createElement('div');
                item.className = 'card';
                item.innerHTML = `
                    <span><strong>${ag.hora}</strong> - ${ag.nome}</span>
                    <button class="btn-excluir" onclick="window.excluir('${docSnap.id}')">Excluir</button>
                `;
                lista.appendChild(item);
            });
        });
    };

    window.excluir = async (id) => {
        if(confirm("Excluir?")) await deleteDoc(doc(db, "agendamentos", id));
    };

</script>
</body>
</html>
