<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, getDocs, setDoc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAxyovmqjNYIzOYYDZZnduquiJQeK4UIgc",
        authDomain: "agendei-d721e.firebaseapp.com",
        projectId: "agendei-d721e",
        storageBucket: "agendei-d721e.firebasestorage.app",
        messagingSenderId: "525023801595",
        appId: "1:525023801595:web:71a6d72e986e6e9e30005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const agendamentosRef = collection(db, "agendamentos");

    // --- NOVA LÓGICA DE CONFIGURAÇÕES REAIS ---
    const configDocRef = doc(db, "configuracoes", "geral");

    // Função para Carregar Configurações ao abrir o app
    async function carregarConfiguracoes() {
        const docSnap = await getDoc(configDocRef);
        if (docSnap.exists()) {
            const dados = docSnap.data();
            document.getElementById('nome_espaco').value = dados.nomeEspaco;
            document.getElementById('msg_padrao').value = dados.mensagemWhatsapp;
            // Atualiza os títulos no app
            document.querySelector('h1').innerText = dados.nomeEspaco;
        }
    }
    carregarConfiguracoes();

    // Função para Salvar Configurações no Firebase
    window.salvarAjustes = async () => {
        const nome = document.getElementById('nome_espaco').value;
        const msg = document.getElementById('msg_padrao').value;

        try {
            await setDoc(configDocRef, {
                nomeEspaco: nome,
                mensagemWhatsapp: msg
            });
            alert("✅ Configurações salvas com sucesso na Nuvem!");
            document.querySelector('h1').innerText = nome;
        } catch (e) {
            alert("Erro ao salvar: " + e);
        }
    };

    // --- RESTANTE DA LÓGICA (AGENDAMENTOS) ---
    window.switchTab = (tabId) => {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if(event) event.currentTarget.classList.add('active');
    };

    document.getElementById('btnSalvar').onclick = async () => {
        const nome = document.getElementById('nome').value;
        const telefone = document.getElementById('telefone').value;
        const data = document.getElementById('data_input').value;
        const hora = document.getElementById('hora_input').value;
        const msgTemplate = document.getElementById('msg_padrao').value;

        if(!nome || !data || !hora) return alert("Preencha o básico!");

        const qConflito = query(agendamentosRef, where("data", "==", data), where("hora", "==", hora));
        const check = await getDocs(qConflito);
        
        if(!check.empty) return alert("⚠️ Esse horário já está ocupado!");

        try {
            await addDoc(agendamentosRef, { nome, telefone, data, hora, timestamp: new Date() });
            
            // WHATSAPP USANDO O MODELO DAS CONFIGURAÇÕES
            let msgFinal = msgTemplate.replace("[NOME]", nome).replace("[DATA]", data).replace("[HORA]", hora);
            window.open(`https://wa.me/55${telefone}?text=${encodeURIComponent(msgFinal)}`, "_blank");
            
            document.getElementById('nome').value = "";
            document.getElementById('telefone').value = "";
        } catch (e) { console.error(e); }
    };

    document.getElementById('data_input').onchange = (e) => {
        const dataSel = e.target.value;
        const q = query(agendamentosRef, where("data", "==", dataSel), orderBy("hora", "asc"));

        onSnapshot(q, (snapshot) => {
            const lista = document.getElementById('lista_agendamentos');
            lista.innerHTML = "";
            document.getElementById('count_hoje').innerText = snapshot.size;

            snapshot.forEach(docSnap => {
                const ag = docSnap.data();
                const item = document.createElement('div');
                item.className = 'card';
                item.innerHTML = `
                    <span><strong>${ag.hora}</strong> - ${ag.nome}</span>
                    <button class="btn-excluir" onclick="window.excluir('${docSnap.id}')">Excluir</button>
                `;
                lista.appendChild(item);
            });
        });
    };

    window.excluir = async (id) => {
        if(confirm("Excluir?")) await deleteDoc(doc(db, "agendamentos", id));
    };
</script>
