<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendei Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #7b5ea7; --secondary: #fdf4ff; --accent: #ff6b81; 
            --bg: linear-gradient(135deg, #f8e8ee, #e3f2fd); --text: #333; --card-bg: #ffffff;
        }
        body.dark-mode { --bg: #1a1a2e; --text: #e0e0e0; --card-bg: #16213e; --secondary: #0f3460; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; transition: 0.3s; }
        .container { background: var(--card-bg); width: 100%; max-width: 500px; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); box-sizing: border-box; }
        .nav-tabs { display: flex; justify-content: space-around; margin-bottom: 25px; border-bottom: 2px solid #eee; }
        .tab-item { padding: 10px; cursor: pointer; font-weight: 600; color: #999; }
        .tab-item.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        h1, h2, h3 { text-align: center; color: var(--primary); }
        label { font-size: 13px; font-weight: 600; display: block; margin-top: 15px; }
        input, select, textarea, button { width: 100%; padding: 12px; margin-top: 6px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
        button { background-color: var(--primary); color: white; border: none; font-weight: 600; cursor: pointer; margin-top: 15px; }
        .card { background: var(--secondary); padding: 12px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #7b5ea715; }
        .btn-excluir { width: auto; background: var(--accent); font-size: 10px; padding: 5px 8px; margin: 0; }
        
        /* LAYOUT VERTICAL */
        .checkbox-group { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
        .checkbox-item { background: var(--secondary); padding: 10px; border-radius: 8px; display: flex; flex-direction: column; gap: 5px; }
        .check-row { display: flex; align-items: center; gap: 10px; }
        .check-row input { width: 20px; height: 20px; margin: 0; }
        .pers-inputs { display: flex; gap: 5px; margin-top: 5px; display: none; } /* Escondido se não selecionado */
        .pers-inputs input { font-size: 11px; padding: 5px; }
        
        .grid-half { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        hr { border: 0; border-top: 1px solid #eee; margin: 25px 0; }
    </style>
</head>
<body id="body">

<div class="container">
    <div class="nav-tabs">
        <div class="tab-item active" id="tab-agendar">Agendar</div>
        <div class="tab-item" id="tab-dashboard">Agenda</div>
        <div class="tab-item" id="tab-config">Ajustes</div>
    </div>

    <div id="sec-agendar" class="content-section active">
        <h1>Agendar</h1>
        <label>Serviço</label>
        <select id="sel-serv-ag"><option value="">Carregando...</option></select>
        <label>Profissional</label>
        <select id="sel-prof-ag"><option value="">Selecione o serviço...</option></select>
        <label>Cliente</label>
        <input type="text" id="cli-nome">
        <div class="grid-half">
            <input type="date" id="cli-data">
            <input type="time" id="cli-hora">
        </div>
        <button id="btn-salvar-ag">Confirmar</button>
    </div>

    <div id="sec-dashboard" class="content-section">
        <h2>Agenda</h2>
        <input type="date" id="filtro-data-agenda">
        <div id="lista-agendamentos" style="margin-top: 15px;"></div>
    </div>

    <div id="sec-config" class="content-section">
        <h2>Ajustes</h2>
        <button id="btn-dark" style="background: #333;">Modo Noturno</button>
        <hr>
        <h3>Cadastrar Serviço Geral</h3>
        <input type="text" id="s-nome" placeholder="Serviço">
        <div class="grid-half">
            <input type="number" id="s-tempo" placeholder="Tempo (min)">
            <input type="number" id="s-preco" placeholder="Preço (R$)">
        </div>
        <label>Quem realiza? (Vertical)</label>
        <div id="check-profs-servico" class="checkbox-group"></div>
        <button id="btn-add-servico">Salvar Serviço</button>
        <div id="lista-servicos-ajustes" style="margin-top:10px;"></div>

        <hr>
        <h3>Equipe</h3>
        <input type="text" id="p-nome" placeholder="Nome do Profissional">
        <button id="btn-add-prof">Adicionar Profissional</button>
        <div id="lista-profissionais-ajustes" style="margin-top:10px;"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, getDocs, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAxyovmqjNYIzOYYDZZnduquiJQeK4UIgc",
        authDomain: "agendei-d721e.firebaseapp.com",
        projectId: "agendei-d721e",
        storageBucket: "agendei-d721e.firebasestorage.app",
        messagingSenderId: "525023801595",
        appId: "1:525023801595:web:71a6d72e986e6e9e30005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const profRef = collection(db, "profissionais");
    const servRef = collection(db, "servicos");
    const agendRef = collection(db, "agendamentos");

    // --- CARREGAR DADOS ---
    onSnapshot(profRef, (snap) => {
        const listaConfig = document.getElementById('lista-profissionais-ajustes');
        const checkGroup = document.getElementById('check-profs-servico');
        listaConfig.innerHTML = ""; checkGroup.innerHTML = "";
        snap.forEach(d => {
            const p = d.data();
            listaConfig.innerHTML += `<div class="card"><span>${p.nome}</span><button class="btn-excluir" onclick="apagar('profissionais', '${d.id}')">X</button></div>`;
            checkGroup.innerHTML += `
                <div class="checkbox-item">
                    <div class="check-row">
                        <input type="checkbox" name="prof-serv" value="${p.nome}" onchange="togglePers(this)">
                        <span>${p.nome}</span>
                    </div>
                    <div class="pers-inputs">
                        <input type="number" placeholder="Tempo (vazio=padrão)" class="p-tempo" data-prof="${p.nome}">
                        <input type="number" placeholder="Preço (vazio=padrão)" class="p-preco" data-prof="${p.nome}">
                    </div>
                </div>`;
        });
    });

    onSnapshot(servRef, (snap) => {
        const listaS = document.getElementById('lista-servicos-ajustes');
        const selS = document.getElementById('sel-serv-ag');
        listaS.innerHTML = ""; selS.innerHTML = '<option value="">Escolha...</option>';
        snap.forEach(d => {
            const s = d.data();
            listaS.innerHTML += `<div class="card"><span>${s.nome} (R$ ${s.preco})</span><button class="btn-excluir" onclick="apagar('servicos', '${d.id}')">X</button></div>`;
            selS.innerHTML += `<option value="${d.id}">${s.nome}</option>`;
        });
    });

    // --- LOGICA DE PERSONALIZAÇÃO ---
    window.togglePers = (el) => {
        const parent = el.closest('.checkbox-item');
        parent.querySelector('.pers-inputs').style.display = el.checked ? 'flex' : 'none';
    };

    document.getElementById('btn-add-servico').onclick = async () => {
        const nome = document.getElementById('s-nome').value;
        const tempo = document.getElementById('s-tempo').value;
        const preco = document.getElementById('s-preco').value;
        const profsChecked = document.querySelectorAll('input[name="prof-serv"]:checked');
        
        let execucoes = {}; // Objeto para guardar quem faz e suas personalizações
        profsChecked.forEach(el => {
            const profNome = el.value;
            const parent = el.closest('.checkbox-item');
            const tPers = parent.querySelector('.p-tempo').value;
            const pPers = parent.querySelector('.p-preco').value;
            execucoes[profNome] = { 
                ativo: true, 
                tempo: tPers || tempo, 
                preco: pPers || preco 
            };
        });

        if(!nome || profsChecked.length === 0) return alert("Preencha o nome e selecione ao menos um profissional!");
        await addDoc(servRef, { nome, tempo, preco, execucoes });
        alert("Serviço Salvo!");
    };

    // --- AGENDA (TAB 2) ---
    document.getElementById('filtro-data-agenda').onchange = (e) => {
        const q = query(agendRef, where("data", "==", e.target.value), orderBy("hora", "asc"));
        onSnapshot(q, (snap) => {
            const lista = document.getElementById('lista-agendamentos');
            lista.innerHTML = "";
            snap.forEach(d => {
                const ag = d.data();
                lista.innerHTML += `<div class="card"><span><b>${ag.hora}</b> - ${ag.cliente}<br><small>${ag.profissional} | ${ag.servico}</small></span><button class="btn-excluir" onclick="apagar('agendamentos', '${d.id}')">X</button></div>`;
            });
        });
    };

    // --- NAVEGAÇÃO ---
    const tabs = { 'tab-agendar': 'sec-agendar', 'tab-dashboard': 'sec-dashboard', 'tab-config': 'sec-config' };
    Object.keys(tabs).forEach(t => document.getElementById(t).onclick = (e) => {
        document.querySelectorAll('.content-section, .tab-item').forEach(el => el.classList.remove('active'));
        document.getElementById(tabs[t]).classList.add('active');
        document.getElementById(t).classList.add('active');
    });

    window.apagar = async (col, id) => { if(confirm("Excluir?")) await deleteDoc(doc(db, col, id)); };
    document.getElementById('btn-add-prof').onclick = async () => {
        const n = document.getElementById('p-nome').value;
        if(n) await addDoc(profRef, { nome: n });
        document.getElementById('p-nome').value = "";
    };
    document.getElementById('btn-dark').onclick = () => document.getElementById('body').classList.toggle('dark-mode');
</script>
</body>
</html>
