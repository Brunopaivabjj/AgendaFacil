<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendei Pro - Gest√£o por Perfil</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #7b5ea7; --secondary: #fdf4ff; --accent: #ff6b81; --edit: #4a90e2;
            --bg: linear-gradient(135deg, #f8e8ee, #e3f2fd); --text: #333; --card-bg: #ffffff;
        }
        body.dark-mode { --bg: #1a1a2e; --text: #e0e0e0; --card-bg: #16213e; --secondary: #0f3460; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; transition: 0.3s; }
        
        .container { background: var(--card-bg); width: 100%; max-width: 500px; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); box-sizing: border-box; }
        
        /* JANELA MODAL */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); margin: 15% auto; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; position: relative; }
        .close { position: absolute; right: 20px; top: 10px; font-size: 28px; cursor: pointer; }

        .nav-tabs { display: flex; justify-content: space-around; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab-item { padding: 10px; cursor: pointer; font-weight: 600; color: #999; }
        .tab-item.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .content-section { display: none; }
        .content-section.active { display: block; }

        h1, h2, h3 { text-align: center; color: var(--primary); margin: 10px 0; }
        label { font-size: 12px; font-weight: 600; display: block; margin-top: 15px; }
        input, select, textarea, button { width: 100%; padding: 12px; margin-top: 6px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
        button { background-color: var(--primary); color: white; border: none; font-weight: 600; cursor: pointer; margin-top: 10px; }
        
        .card-perfil { background: var(--secondary); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #7b5ea744; }
        .servico-item { background: white; padding: 8px; border-radius: 8px; margin-top: 5px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        
        .actions { display: flex; gap: 5px; }
        .btn-mini { width: auto; font-size: 10px; padding: 5px 8px; margin: 0; border-radius: 5px; }
        .btn-edit { background: var(--edit); }
        .btn-del { background: var(--accent); }
        .btn-add { background: #2ecc71; font-size: 11px; margin-top: 10px; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .footer { text-align: center; font-size: 11px; margin-top: 20px; color: #999; }
    </style>
</head>
<body id="body">

<div class="container">
    <div class="nav-tabs">
        <div class="tab-item active" id="tab-agendar">Agendar</div>
        <div class="tab-item" id="tab-dashboard">Agenda</div>
        <div class="tab-item" id="tab-config">Config</div>
    </div>

    <div id="sec-agendar" class="content-section active">
        <h2 id="txt-nome-espaco">Klebylenne Moraes</h2>
        <label>Selecione o Profissional</label>
        <select id="sel-prof-ag"><option value="">Carregando...</option></select>
        
        <label>Servi√ßo (com tempo espec√≠fico deste profissional)</label>
        <select id="sel-serv-ag"><option value="">Selecione o profissional primeiro...</option></select>
        
        <label>Cliente</label>
        <input type="text" id="cli-nome">
        <div class="grid-2">
            <div><label>Data</label><input type="date" id="cli-data"></div>
            <div><label>Hora</label><input type="time" id="cli-hora"></div>
        </div>
        <button id="btn-finalizar">Marcar Hor√°rio</button>
    </div>

    <div id="sec-dashboard" class="content-section">
        <h2>Agenda</h2>
        <input type="date" id="filtro-data-agenda">
        <div id="lista-agenda-dia" style="margin-top:20px;"></div>
    </div>

    <div id="sec-config" class="content-section">
        <h3>Gest√£o de Perfis</h3>
        <button id="btn-add-prof-modal" style="background:#2ecc71;">+ Novo Profissional</button>
        <div id="container-perfis" style="margin-top:20px;"></div>
    </div>
</div>

<div id="modal-prof" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModais()">&times;</span>
        <h3 id="modal-prof-titulo">Novo Profissional</h3>
        <input type="hidden" id="modal-prof-id">
        <label>Nome</label>
        <input type="text" id="modal-prof-nome">
        <button id="btn-salvar-prof">Confirmar</button>
    </div>
</div>

<div id="modal-serv" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModais()">&times;</span>
        <h3 id="modal-serv-titulo">Configurar Servi√ßo</h3>
        <input type="hidden" id="modal-serv-prof-id">
        <input type="hidden" id="modal-serv-index">
        
        <label>Nome do Servi√ßo</label>
        <input type="text" id="modal-serv-nome" placeholder="Ex: C√≠lios">
        <div class="grid-2">
            <div><label>Tempo (min)</label><input type="number" id="modal-serv-tempo"></div>
            <div><label>Pre√ßo R$</label><input type="number" id="modal-serv-preco"></div>
        </div>
        <button id="btn-salvar-serv">Salvar no Perfil</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, getDocs, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAxyovmqjNYIzOYYDZZnduquiJQeK4UIgc",
        authDomain: "agendei-d721e.firebaseapp.com",
        projectId: "agendei-d721e",
        storageBucket: "agendei-d721e.firebasestorage.app",
        messagingSenderId: "525023801595",
        appId: "1:525023801595:web:71a6d72e986e6e9e30005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colProfs = collection(db, "profissionais");

    // --- ABRIR MODAIS ---
    window.fecharModais = () => { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); };
    document.getElementById('btn-add-prof-modal').onclick = () => {
        document.getElementById('modal-prof-id').value = "";
        document.getElementById('modal-prof-nome').value = "";
        document.getElementById('modal-prof-titulo').innerText = "Novo Profissional";
        document.getElementById('modal-prof').style.display = 'block';
    };

    // --- GEST√ÉO DE PROFISSIONAIS (PERFIS) ---
    onSnapshot(colProfs, (snap) => {
        const container = document.getElementById('container-perfis');
        const selProfAg = document.getElementById('sel-prof-ag');
        container.innerHTML = "";
        selProfAg.innerHTML = '<option value="">Selecione...</option>';

        snap.forEach(d => {
            const p = d.data();
            selProfAg.innerHTML += `<option value="${d.id}">${p.nome}</option>`;

            let servicosHtml = (p.servicos || []).map((s, idx) => `
                <div class="servico-item">
                    <span>${s.nome} - <strong>${s.tempo}min</strong></span>
                    <button class="btn-mini btn-del" onclick="removerServico('${d.id}', ${idx})">X</button>
                </div>
            `).join('');

            container.innerHTML += `
                <div class="card-perfil">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <strong>üë§ ${p.nome}</strong>
                        <div class="actions">
                            <button class="btn-mini btn-edit" onclick="abrirEditarProf('${d.id}', '${p.nome}')">‚úé</button>
                            <button class="btn-mini btn-del" onclick="removerDoc('profissionais', '${d.id}')">Excluir</button>
                        </div>
                    </div>
                    <div id="servs-${d.id}">${servicosHtml}</div>
                    <button class="btn-add" onclick="abrirAddServico('${d.id}')">+ Adicionar Servi√ßo p/ ${p.nome}</button>
                </div>
            `;
        });
    });

    // --- SALVAR PROFISSIONAL ---
    document.getElementById('btn-salvar-prof').onclick = async () => {
        const id = document.getElementById('modal-prof-id').value;
        const nome = document.getElementById('modal-prof-nome').value;
        if(!nome) return;
        if(id) await updateDoc(doc(db, "profissionais", id), { nome });
        else await addDoc(colProfs, { nome, servicos: [] });
        fecharModais();
    };

    window.abrirEditarProf = (id, nome) => {
        document.getElementById('modal-prof-id').value = id;
        document.getElementById('modal-prof-nome').value = nome;
        document.getElementById('modal-prof-titulo').innerText = "Editar Nome";
        document.getElementById('modal-prof').style.display = 'block';
    };

    // --- SERVI√áOS DO PERFIL ---
    window.abrirAddServico = (profId) => {
        document.getElementById('modal-serv-prof-id').value = profId;
        document.getElementById('modal-serv-nome').value = "";
        document.getElementById('modal-serv-tempo').value = "";
        document.getElementById('modal-serv-preco').value = "";
        document.getElementById('modal-serv').style.display = 'block';
    };

    document.getElementById('btn-salvar-serv').onclick = async () => {
        const profId = document.getElementById('modal-serv-prof-id').value;
        const novoServ = {
            nome: document.getElementById('modal-serv-nome').value,
            tempo: document.getElementById('modal-serv-tempo').value,
            preco: document.getElementById('modal-serv-preco').value
        };
        await updateDoc(doc(db, "profissionais", profId), {
            servicos: arrayUnion(novoServ)
        });
        fecharModais();
    };

    window.removerServico = async (profId, index) => {
        if(!confirm("Remover este servi√ßo do perfil?")) return;
        const d = await getDoc(doc(db, "profissionais", profId));
        const servs = d.data().servicos;
        servs.splice(index, 1);
        await updateDoc(doc(db, "profissionais", profId), { servicos: servs });
    };

    // --- AGENDAMENTO INTELIGENTE ---
    document.getElementById('sel-prof-ag').onchange = async (e) => {
        const profId = e.target.value;
        const selServ = document.getElementById('sel-serv-ag');
        if(!profId) return selServ.innerHTML = "<option>Escolha o profissional...</option>";
        
        const d = await getDoc(doc(db, "profissionais", profId));
        const servs = d.data().servicos || [];
        selServ.innerHTML = '<option value="">Qual servi√ßo?</option>';
        servs.forEach(s => {
            selServ.innerHTML += `<option value="${s.nome}" data-tempo="${s.tempo}">${s.nome} (${s.tempo}min)</option>`;
        });
    };

    // --- NAVEGA√á√ÉO ---
    window.switchTab = (id) => {
        const tabs = {'tab-agendar':'sec-agendar', 'tab-dashboard':'sec-dashboard', 'tab-config':'sec-config'};
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(tabs[id]).classList.add('active');
        document.getElementById(id).classList.add('active');
    };
    document.querySelectorAll('.tab-item').forEach(t => t.onclick = () => window.switchTab(t.id));
    window.removerDoc = async (col, id) => { if(confirm("Excluir?")) await deleteDoc(doc(db, col, id)); };

</script>
</body>
</html>
