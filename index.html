<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendei</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #7b5ea7; --secondary: #fdf4ff; --accent: #ff6b81; --edit: #4a90e2;
            --bg: linear-gradient(135deg, #f8e8ee, #e3f2fd); --text: #333; --card-bg: #ffffff;
        }
        body { margin:0; font-family:'Poppins', sans-serif; background:var(--bg); color:var(--text); min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:20px; transition:0.3s; }
        .container { background: var(--card-bg); width:100%; max-width:500px; border-radius:20px; padding:25px; box-shadow:0 10px 30px rgba(0,0,0,0.1); box-sizing:border-box; }

        /* LOGIN */
        #tela-login { display:flex; flex-direction:column; gap:15px; text-align:center; }
        #tela-login input { width:100%; padding:12px; border-radius:10px; border:1px solid #ddd; margin-top:6px; box-sizing:border-box; font-family:inherit; }
        #tela-login button { background:var(--primary); color:white; border:none; font-weight:600; cursor:pointer; padding:12px; border-radius:10px; margin-top:6px; }

        /* APP */
        #app-principal { display:none; width:100%; }
        .nav-tabs { display:flex; justify-content:space-around; margin-bottom:25px; border-bottom:2px solid #eee; }
        .tab-item { padding:10px; cursor:pointer; font-weight:600; color:#999; }
        .tab-item.active { color:var(--primary); border-bottom:3px solid var(--primary); }
        .content-section { display:none; }
        .content-section.active { display:block; }
        label { font-size:13px; font-weight:600; display:block; margin-top:15px; }
        input, select, button { width:100%; padding:12px; margin-top:6px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box; font-family:inherit; }
        button { background-color:var(--primary); color:white; border:none; font-weight:600; cursor:pointer; }
        .card-item { background:var(--secondary); padding:15px; border-radius:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #7b5ea722; }
        .actions { display:flex; gap:8px; }
        .btn-mini { width:auto; font-size:12px; padding:6px 10px; margin:0; border-radius:8px; }
        .btn-edit { background: var(--edit); }
        .btn-del { background: var(--accent); }
        .grid-half { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        hr { border:0; border-top:1px solid #eee; margin:25px 0; }
    </style>
</head>
<body>

<!-- TELA DE LOGIN -->
<div id="tela-login" class="container">
    <h2>Agendei</h2>
    <input type="email" id="login-email" placeholder="E-mail">
    <input type="password" id="login-senha" placeholder="Senha">
    <button id="btn-entrar">Entrar</button>
    <p style="color:#666; font-size:12px; margin-top:10px;">Email: oagendei@gmail.com | Senha: 2020191</p>
</div>

<!-- APP PRINCIPAL -->
<div id="app-principal" class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <small id="user-display" style="color:var(--primary); font-weight:600;"></small>
        <button id="btn-sair" class="btn-mini btn-del">Sair</button>
    </div>

    <div class="nav-tabs">
        <div class="tab-item active" id="tab-agendar">Agendar</div>
        <div class="tab-item" id="tab-dashboard">Agenda</div>
        <div class="tab-item" id="tab-config">Ajustes</div>
    </div>

    <div id="sec-agendar" class="content-section active">
        <h2>Novo Agendamento</h2>
        <label>Servi√ßo Geral</label>
        <select id="sel-serv-ag"><option value="">Carregando...</option></select>
        <label>Profissional</label>
        <select id="sel-prof-ag"><option value="">Selecione o servi√ßo...</option></select>
        <label>Cliente</label>
        <input type="text" id="cli-nome">
        <div class="grid-half">
            <input type="date" id="cli-data">
            <input type="time" id="cli-hora">
        </div>
        <button id="btn-confirmar-ag">Confirmar Agendamento</button>
    </div>

    <div id="sec-dashboard" class="content-section">
        <h2>Agenda</h2>
        <input type="date" id="filtro-data-ver">
        <div id="lista-agendamentos-dia" style="margin-top:20px;"></div>
    </div>

    <div id="sec-config" class="content-section">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button onclick="abrirModalServico()" style="background:#2ecc71;">+ Novo Servi√ßo</button>
            <button onclick="abrirModalProf()" style="background:#2ecc71;">+ Novo Profissional</button>
        </div>
        <h3>Servi√ßos Gerais</h3>
        <div id="lista-serv-gerais"></div>
        <hr>
        <h3>Equipe / Perfis</h3>
        <div id="lista-perfis-equipe"></div>
    </div>
</div>

<!-- MODAIS -->
<div id="modal-servico" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModais()">&times;</span>
        <h3 id="titulo-servico">Servi√ßo Geral</h3>
        <input type="hidden" id="gs-id-edit">
        <label>Nome do Servi√ßo</label>
        <input type="text" id="gs-nome">
        <div class="grid-half">
            <div><label>Tempo Padr√£o</label><input type="number" id="gs-tempo"></div>
            <div><label>Pre√ßo Padr√£o</label><input type="number" id="gs-preco"></div>
        </div>
        <button id="btn-salvar-serv-geral" style="margin-top:20px;">Salvar Servi√ßo</button>
    </div>
</div>

<div id="modal-perfil" class="modal">
    <div class="modal-content">
        <span class="close" onclick="fecharModais()">&times;</span>
        <h3 id="modal-titulo-nome">Editar Perfil</h3>
        <input type="hidden" id="modal-prof-id">
        <label>Nome do Colaborador</label>
        <input type="text" id="modal-input-nome">
        <h4 style="margin-top:20px; color:var(--primary);">Servi√ßos Prestados:</h4>
        <div id="lista-servicos-personalizados"></div>
        <button id="btn-salvar-perfil-total" style="background:#2ecc71; margin-top:20px;">Salvar Altera√ß√µes</button>
    </div>
</div>

<!-- SCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, getDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// --- CONFIG FIREBASE ---
const firebaseConfig = {
    apiKey: "AIzaSyAxyovmqjNYIzOYYDZZnduquiJQeK4UIgc",
    authDomain: "agendei-d721e.firebaseapp.com",
    projectId: "agendei-d721e",
    storageBucket: "agendei-d721e.firebasestorage.app",
    messagingSenderId: "525023801595",
    appId: "1:525023801595:web:71a6d72e986e6e9e30005e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- LOGIN --- 
const emailAdm = "oagendei@gmail.com";
const senhaAdm = "2020191";

document.getElementById('btn-entrar').onclick = () => {
    const email = document.getElementById('login-email').value;
    const senha = document.getElementById('login-senha').value;
    if(email !== emailAdm || senha !== senhaAdm){
        alert("Email ou senha incorretos!");
        return;
    }
    signInWithEmailAndPassword(auth, email, senha)
    .then(() => {
        // login bem sucedido
    })
    .catch(e => alert("Erro no login: "+e.message));
};

// --- OBSERVADOR DE LOGIN ---
onAuthStateChanged(auth, (user) => {
    if(user){
        document.getElementById('tela-login').style.display = 'none';
        document.getElementById('app-principal').style.display = 'block';
        document.getElementById('user-display').innerText = user.email;
        carregarDados();
    } else {
        document.getElementById('tela-login').style.display = 'flex';
        document.getElementById('app-principal').style.display = 'none';
    }
});

// --- LOGOUT ---
document.getElementById('btn-sair').onclick = () => signOut(auth);

// --- FIRESTORE REAL-TIME ---
const colServs = collection(db, "servicos_gerais");
const colProfs = collection(db, "profissionais");

let servicosCache = [];

function carregarDados(){
    onSnapshot(colServs, snap=>{
        const lista = document.getElementById('lista-serv-gerais');
        const sel = document.getElementById('sel-serv-ag');
        lista.innerHTML=""; sel.innerHTML='<option value="">Escolha o servi√ßo...</option>';
        servicosCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
        servicosCache.forEach(s=>{
            lista.innerHTML+=`
            <div class="card-item">
                <span>${s.nome} <br><small>R$ ${s.preco} | ${s.tempo}min</small></span>
                <div class="actions">
                    <button class="btn-mini btn-edit" onclick="abrirModalServico('${s.id}')">‚úé</button>
                    <button class="btn-mini btn-del" onclick="remover('servicos_gerais','${s.id}')">X</button>
                </div>
            </div>`;
            sel.innerHTML+=`<option value="${s.id}">${s.nome}</option>`;
        });
    });

    onSnapshot(colProfs, snap=>{
        const lista = document.getElementById('lista-perfis-equipe');
        lista.innerHTML="";
        snap.forEach(d=>{
            const p = d.data();
            lista.innerHTML+=`<div class="card-item"><span>üë§ ${p.nome}</span><button class="btn-mini btn-edit" onclick="abrirPerfil('${d.id}')">Editar Perfil</button></div>`;
        });
    });
}

// --- MODAIS ---
window.abrirModalServico = async (id=null)=>{
    if(id){
        const d = await getDoc(doc(db,"servicos_gerais",id));
        const s = d.data();
        document.getElementById('gs-id-edit').value=id;
        document.getElementById('gs-nome').value=s.nome;
        document.getElementById('gs-tempo').value=s.tempo;
        document.getElementById('gs-preco').value=s.preco;
        document.getElementById('titulo-servico').innerText="Editar Servi√ßo";
    }else{
        document.getElementById('gs-id-edit').value="";
        document.getElementById('gs-nome').value="";
        document.getElementById('gs-tempo').value="";
        document.getElementById('gs-preco').value="";
        document.getElementById('titulo-servico').innerText="Novo Servi√ßo";
    }
    document.getElementById('modal-servico').style.display='block';
};

document.getElementById('btn-salvar-serv-geral').onclick=async()=>{
    const id=document.getElementById('gs-id-edit').value;
    const dados={
        nome:document.getElementById('gs-nome').value,
        tempo:document.getElementById('gs-tempo').value,
        preco:document.getElementById('gs-preco').value
    };
    if(id) await updateDoc(doc(db,"servicos_gerais",id),dados);
    else await addDoc(colServs,dados);
    fecharModais();
};

window.fecharModais=()=>{ document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); };
window.remover=async(c,id)=>{ if(confirm("Deseja excluir?")) await deleteDoc(doc(db,c,id)); };

window.abrirModalProf=()=>{
    document.getElementById('modal-prof-id').value="";
    document.getElementById('modal-input-nome').value="";
    document.getElementById('lista-servicos-personalizados').innerHTML="<p style='font-size:12px; color:gray;'>Salve o profissional primeiro para liberar a personaliza√ß√£o de servi√ßos.</p>";
    document.getElementById('modal-perfil').style.display='block';
};

window.abrirPerfil=async(id)=>{
    const d = await getDoc(doc(db,"profissionais",id));
    const prof = d.data();
    const excecoes = prof.excecoes||{};
    document.getElementById('modal-prof-id').value=id;
    document.getElementById('modal-input-nome').value=prof.nome;
    const lista=document.getElementById('lista-servicos-personalizados');
    lista.innerHTML="";
    servicosCache.forEach(s=>{
        const exc = excecoes[s.id]||{tempo:"",preco:"",ativo:false};
        lista.innerHTML+=`
        <div class="card-item">
            <input type="checkbox" id="check-${s.id}" ${exc.ativo?'checked':''}> <strong>${s.nome}</strong>
            <div class="grid-half">
                <input type="number" id="t-${s.id}" value="${exc.tempo}" placeholder="Tempo">
                <input type="number" id="p-${s.id}" value="${exc.preco}" placeholder="Pre√ßo">
            </div>
        </div>`;
    });
    document.getElementById('modal-perfil').style.display='block';
};

document.getElementById('btn-salvar-perfil-total').onclick=async()=>{
    const id=document.getElementById('modal-prof-id').value;
    const nome=document.getElementById('modal-input-nome').value;
    const excecoes={};
    servicosCache.forEach(s=>{
        const check=document.getElementById(`check-${s.id}`);
        if(check && check.checked){
            excecoes[s.id]={ativo:true,tempo:document.getElementById(`t-${s.id}`).value,preco:document.getElementById(`p-${s.id}`).value};
        }
    });
    if(id) await updateDoc(doc(db,"profissionais",id),{nome,excecoes});
    else await addDoc(colProfs,{nome,excecoes:{}});
    fecharModais();
};

// --- NAV TABS ---
const tabs={'tab-agendar':'sec-agendar','tab-dashboard':'sec-dashboard','tab-config':'sec-config'};
Object.keys(tabs).forEach(t=>document.getElementById(t).onclick=()=>{
    document.querySelectorAll('.content-section,.tab-item').forEach(el=>el.classList.remove('active'));
    document.getElementById(tabs[t]).classList.add('active');
    document.getElementById(t).classList.add('active');
});
</script>
</body>
</html>
